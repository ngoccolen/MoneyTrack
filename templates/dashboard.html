{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <h1>T·ªïng Quan T√†i Ch√≠nh</h1>
    <p>Theo d√µi chi ti√™u v√† thu nh·∫≠p c·ªßa b·∫°n</p>
</div>

<div class="cta-banner">
    <div style="flex-shrink: 0; font-size: 40px;">üí°</div>
    <div>
        <h3>ü™¥ H√†nh tr√¨nh b·∫Øt ƒë·∫ßu!</h3>
        <p>B·∫°n m·ªõi ƒë·∫°t 0.0% m·ª•c ti√™u thu nh·∫≠p. H√¥m nay l√† ng√†y tuy·ªát v·ªùi ƒë·ªÉ b·∫Øt ƒë·∫ßu b·ª©t ph√°! H√£y nh·∫≠p giao d·ªãch ƒë·∫ßu ti√™n.</p>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card income-card">
        <div class="stat-label">T·ªïng Thu (Th√°ng)</div>
        <div class="stat-value">{{ vnd(kpi_data.income) }}ƒë</div>
        <div class="stat-change color-success">
            ‚Üë 10% 
        </div>
    </div>

    <div class="stat-card expense-card">
        <div class="stat-label">T·ªïng Chi (Th√°ng)</div>
        <div class="stat-value">{{ vnd(kpi_data.expense) }}ƒë</div>
        <div class="stat-change color-danger">
            ‚Üì 5% 
        </div>
    </div>

    <div class="stat-card balance-card">
        <div class="stat-label">S·ªë D∆∞ T·ªïng</div>
        <div class="stat-value">{{ vnd(kpi_data.balance) }}ƒë</div>
        <div class="stat-change color-secondary">
             ‚Üì 5%
        </div>
    </div>

    <div class="stat-card saving-card">
        <div class="stat-label">T·ª∑ L·ªá Ti·∫øt Ki·ªám</div>
        <div class="stat-value">{{ kpi_data.saving_pct | round(1) }}%</div>
        <div class="stat-change color-success">
            ‚Üë 2% 
        </div>
    </div>
</div>

<div class="charts-section">
    <h2 class="section-title" style="font-size: 24px; font-weight: 700; margin-bottom: 24px; color: #1e293b;">Xu H∆∞·ªõng D√≤ng Ti·ªÅn & Ph√¢n T√≠ch Chi Ti√™u</h2>
    
    <div class="charts-grid" style="margin-bottom: 24px;">
        <div class="chart-card large">
            <div class="chart-header">D√≤ng Ti·ªÅn Thu/Chi R√≤ng 6 Th√°ng G·∫ßn Nh·∫•t</div>
            <div class="chart-container">
                <canvas id="monthlyFlowChart"></canvas> 
            </div>
        </div>

        <div class="chart-card small">
            <div class="chart-header">Chi Ti√™u Theo Danh M·ª•c</div>
            <div class="chart-container" style="height: 250px;">
                <canvas id="categoryPieChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-6">
            <div class="chart-card">
                <div class="chart-header">Xu H∆∞·ªõng Thu Nh·∫≠p 6 Th√°ng</div>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="monthlyIncomeChart"></canvas> 
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="chart-card">
                <div class="chart-header">Xu H∆∞·ªõng Chi Ti√™u 6 Th√°ng</div>
                <div class="chart-container" style="height: 250px;">
                    <canvas id="monthlyExpenseChart"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const PRIMARY_COLOR = '#667eea'; 
    const SUCCESS_COLOR = '#10b981'; 
    const DANGER_COLOR = '#ef4444';  
    const ACCENT_COLORS = [
        PRIMARY_COLOR, 
        '#764ba2', 
        '#4facfe', 
        '#feca57', 
        '#fa709a', 
        '#43e97b', 
    ];

    const categoryLabels = JSON.parse('{{ category_labels_json | safe }}');
    const categoryValues = JSON.parse('{{ category_values_json | safe }}');
    
    const monthlyLabels = ['Th7', 'Th8', 'Th9', 'Th10', 'Th11', 'Th12']; 
    const monthlyIncome = [20000, 18000, 22000, 19000, 21000, 25000];
    const monthlyExpenseRaw = [10000, 12000, 15000, 11000, 14000, 16000]; 
    const monthlyExpenseNegative = monthlyExpenseRaw.map(v => -v); 
    

    function createLineChart(ctx, label, data, color) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: monthlyLabels,
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '30', 
                    tension: 0.4, 
                    fill: true, 
                    pointRadius: 4,
                    pointHoverRadius: 6,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { color: '#e2e8f0', drawBorder: false },
                        ticks: { 
                            font: { size: 12 }, color: '#64748b',
                            callback: function(value) {
                                return value.toLocaleString() + 'K';
                            } 
                        },
                    },
                    x: { 
                        grid: { display: false, drawBorder: false },
                        ticks: { font: { size: 12, weight: '600' }, color: '#1e293b' },
                    }
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.9)', 
                        padding: 10,
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        cornerRadius: 6
                    }
                }
            }
        });
    }

    // 1. Bi·ªÉu ƒë·ªì ƒê∆∞·ªùng: Thu Nh·∫≠p Theo Th√°ng
    const incomeCtx = document.getElementById('monthlyIncomeChart').getContext('2d');
    createLineChart(incomeCtx, 'Thu nh·∫≠p', monthlyIncome, SUCCESS_COLOR);
    
    // 2. Bi·ªÉu ƒë·ªì ƒê∆∞·ªùng: Chi Ti√™u Theo Th√°ng
    const expenseCtx = document.getElementById('monthlyExpenseChart').getContext('2d');
    createLineChart(expenseCtx, 'Chi ti√™u', monthlyExpenseRaw, DANGER_COLOR);


    // 3. Bi·ªÉu ƒë·ªì C·ªôt: D√≤ng Ti·ªÅn Thu/Chi 
    const flowCtx = document.getElementById('monthlyFlowChart').getContext('2d');
    new Chart(flowCtx, {
        type: 'bar',
        data: {
            labels: monthlyLabels,
            datasets: [
                {
                    label: 'Thu nh·∫≠p (Ng√†n VND)',
                    data: monthlyIncome,
                    backgroundColor: SUCCESS_COLOR,
                    borderRadius: 6,
                },
                {
                    label: 'Chi ti√™u (Ng√†n VND)',
                    data: monthlyExpenseNegative, 
                    backgroundColor: DANGER_COLOR,
                    borderRadius: 6,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            barPercentage: 0.8,
            categoryPercentage: 0.8,
            scales: {
                y: { 
                    beginAtZero: false,
                    grid: { color: '#e2e8f0', drawBorder: false },
                    ticks: { font: { size: 12 }, color: '#64748b',
                        callback: function(value, index, ticks) {
                            return Math.abs(value).toLocaleString() + 'K'; 
                        } 
                    },
                    stacked: false
                },
                x: { 
                    grid: { display: false, drawBorder: false },
                    ticks: { font: { size: 12, weight: '600' }, color: '#1e293b' },
                    stacked: false
                }
            },
            plugins: { 
                legend: { 
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        pointStyle: 'circle',
                        padding: 16
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.9)',
                    padding: 10,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    cornerRadius: 6
                }
            }
        }
    });

    // 4. Bi·ªÉu ƒë·ªì Tr√≤n - Chi Ti√™u Theo Danh M·ª•c
    const pieCtx = document.getElementById('categoryPieChart').getContext('2d');
    new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryValues,
                backgroundColor: ACCENT_COLORS,
                borderWidth: 0, 
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    position: 'right', 
                    labels: {
                        padding: 16,
                        font: { size: 12, weight: '600' },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.9)', 
                    padding: 10,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    cornerRadius: 6
                }
            },
            cutout: '70%'
        }
    });
    
</script>
{% endblock %}