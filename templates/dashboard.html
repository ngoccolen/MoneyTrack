{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <h1>T·ªïng Quan T√†i Ch√≠nh</h1>
    <p>Theo d√µi chi ti√™u v√† thu nh·∫≠p c·ªßa b·∫°n</p>
</div>

<div id="ai-widget-container">
    <div id="ai-chat-window" class="ai-chat-hidden">
        <div class="ai-chat-header">
            <span>‚ú® AI Assistant</span>
            <button id="close-chat" style="background:none; border:none; color:white; cursor:pointer; font-size:20px;">&times;</button>
        </div>
        <div class="ai-chat-body" style="padding: 15px;">
            <p style="font-size: 12px; color: #64748b; margin-bottom: 10px;">Nh·∫≠p chi ti√™u (VD: "cafe s√°ng 35k")</p>
            <textarea id="ai-chat-input" placeholder="B·∫°n ƒë√£ chi g√¨ h√¥m nay..." 
                      style="width: 100%; height: 70px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; resize: none; font-size: 14px;"></textarea>
            
            <div id="ai-chat-result" style="margin-top: 10px;"></div>
        </div>
        <div class="ai-chat-footer" style="padding: 10px;">
            <button id="btn-ai-process" class="btn btn-primary" style="width: 100%; padding: 8px; border-radius: 8px;">Ph√¢n t√≠ch AI</button>
        </div>
    </div>

    <button id="ai-float-button" title="H·ªó tr·ª£ AI">
        <span>‚ú®</span>
    </button>
</div>

<div class="cta-banner">
    <div style="flex-shrink: 0; font-size: 40px;">üí°</div>
    <div>
        <h3>ü™¥ H√†nh tr√¨nh b·∫Øt ƒë·∫ßu!</h3>
        <p>B·∫°n m·ªõi ƒë·∫°t 0.0% m·ª•c ti√™u thu nh·∫≠p. H√¥m nay l√† ng√†y tuy·ªát v·ªùi ƒë·ªÉ b·∫Øt ƒë·∫ßu b·ª©t ph√°! H√£y nh·∫≠p giao d·ªãch ƒë·∫ßu ti√™n.</p>
    </div>
</div>

<div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
    <div class="stat-card wallet-card" onclick="openBalanceModal()" style="cursor: pointer; border: 2px dashed #667eea; background: #f8fafc;">
        <div class="stat-label">V√≠ Ch√≠nh (Ban ƒë·∫ßu)</div>
        <div class="stat-value" id="display-balance">{{ vnd(account.balance if account else 0) }}ƒë</div>
        <div class="stat-change" style="color: #667eea;">Ch·∫°m ƒë·ªÉ c·∫≠p nh·∫≠t</div>
    </div>

    <div class="stat-card income-card">
        <div class="stat-label">T·ªïng Thu (Th√°ng)</div>
        <div class="stat-value">{{ vnd(kpi_data.income) }}ƒë</div>
        <div class="stat-change color-success">‚Üë 10% </div>
    </div>

    <div class="stat-card expense-card">
        <div class="stat-label">T·ªïng Chi (Th√°ng)</div>
        <div class="stat-value">{{ vnd(kpi_data.expense) }}ƒë</div>
        <div class="stat-change color-danger">‚Üì 5% </div>
    </div>

    <div class="stat-card balance-card">
        <div class="stat-label">S·ªë D∆∞ Hi·ªán T·∫°i</div>
        <div class="stat-value">{{ vnd(kpi_data.balance) }}ƒë</div>
        <div class="stat-change color-secondary">Kh·∫£ d·ª•ng</div>
    </div>
</div>

<div id="balanceModal" class="modal-overlay">
    <div class="modal-content">
        <h3>C·∫≠p nh·∫≠t s·ªë d∆∞ ban ƒë·∫ßu</h3>
        <p style="font-size: 13px; color: #64748b; margin-bottom: 15px;">Nh·∫≠p s·ªë ti·ªÅn th·ª±c t·∫ø b·∫°n ƒëang c√≥ trong v√≠</p>
        <form action="{{ url_for('update_balance') }}" method="POST">
            <input type="number" name="balance" class="modern-input" 
                   placeholder="VD: 5000000" required autofocus 
                   style="width: 100%; font-size: 1.2rem; padding: 12px; margin-bottom: 15px;">
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn" onclick="closeBalanceModal()" style="flex: 1; background: #e2e8f0;">H·ªßy</button>
                <button type="submit" class="btn btn-primary" style="flex: 2;">L∆∞u s·ªë d∆∞</button>
            </div>
        </form>
    </div>
</div>
<div class="dashboard-filter" style="margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;">
    <div class="quick-filters" style="display: flex; gap: 8px;">
        <button class="btn-input-pill active">Th√°ng n√†y</button>
        <button class="btn-input-pill">Th√°ng tr∆∞·ªõc</button>
        <button class="btn-input-pill">6 th√°ng qua</button>
    </div>
    
    <div style="display: flex; align-items: center; gap: 10px;">
        <input type="date" class="filter-input" id="dash-start">
        <span style="color: #64748b;">-</span>
        <input type="date" class="filter-input" id="dash-end">
        <button class="btn-filter" style="padding: 6px 12px;">C·∫≠p nh·∫≠t</button>
    </div>
</div>

<style>
    /* CSS cho c√°c n√∫t h√¨nh con nh·ªông */
    .btn-input-pill {
        padding: 6px 16px;
        border-radius: 20px;
        border: 1px solid var(--color-border);
        background: white;
        color: var(--color-text-secondary);
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-input-pill.active {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
    }
    .btn-input-pill:hover:not(.active) {
        background: #f1f5f9;
    }
</style>

<div class="charts-section">
    <h2 class="section-title" style="font-size: 24px; font-weight: 700; margin-bottom: 24px; color: #1e293b;">Xu H∆∞·ªõng D√≤ng Ti·ªÅn & Ph√¢n T√≠ch Chi Ti√™u</h2>
    
    <div class="charts-grid" style="margin-bottom: 24px;">
        <div class="chart-card large">
            <div class="chart-header">D√≤ng Ti·ªÅn Thu/Chi R√≤ng 6 Th√°ng G·∫ßn Nh·∫•t</div>
            <div class="chart-container"><canvas id="monthlyFlowChart"></canvas></div>
        </div>

        <div class="chart-card small">
            <div class="chart-header">Chi Ti√™u Theo Danh M·ª•c</div>
            <div class="chart-container" style="height: 250px;"><canvas id="categoryPieChart"></canvas></div>
        </div>
    </div>
</div>

<style>
    #ai-widget-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
    #ai-float-button {
        width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        font-size: 24px; transition: transform 0.3s ease;
    }
    #ai-float-button:hover { transform: scale(1.1); }
    #ai-chat-window {
        position: absolute; bottom: 80px; right: 0; width: 300px; background: white;
        border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); display: flex; flex-direction: column;
        transition: all 0.3s ease;
    }
    .ai-chat-header { background: #667eea; color: white; padding: 10px 15px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .ai-chat-hidden { visibility: hidden; opacity: 0; transform: translateY(20px); }
</style>

<script>
    // 1. LOGIC CHO AI WIDGET
    const floatBtn = document.getElementById('ai-float-button');
    const chatWindow = document.getElementById('ai-chat-window');
    const closeBtn = document.getElementById('close-chat');
    const aiBtn = document.getElementById('btn-ai-process');
    const aiInput = document.getElementById('ai-chat-input');
    const aiResult = document.getElementById('ai-chat-result');

    floatBtn.addEventListener('click', () => chatWindow.classList.toggle('ai-chat-hidden'));
    closeBtn.addEventListener('click', () => chatWindow.classList.add('ai-chat-hidden'));

    aiBtn.addEventListener('click', async () => {
        const text = aiInput.value.trim();
        if (!text) return;
        aiBtn.innerText = "ƒêang ph√¢n t√≠ch...";
        
        try {
            const resp = await fetch('/api/ai-input', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            const res = await resp.json();
            
            if (res.success) {
                const d = res.data;
                aiResult.innerHTML = `
                    <div style="background:#f0f7ff; padding:10px; border-radius:8px; font-size:13px; border-left:4px solid #667eea;">
                        <b>S·ªë ti·ªÅn:</b> ${parseInt(d.amount).toLocaleString()}ƒë<br>
                        <b>Lo·∫°i:</b> ${d.category}<br>
                        <button onclick='saveAI("${btoa(JSON.stringify(d))}")' 
                                style="width:100%; margin-top:8px; background:#10b981; color:white; border:none; border-radius:5px; padding:6px; cursor:pointer;">L∆∞u ngay</button>
                    </div>`;
            } else { alert(res.message); }
        } catch (e) { alert("L·ªói k·∫øt n·ªëi API AI"); }
        finally { aiBtn.innerText = "Ph√¢n t√≠ch AI"; }
    });

    async function saveAI(encodedData) {
        const data = JSON.parse(atob(encodedData));
        const formData = new FormData();
        formData.append('amount', data.amount);
        formData.append('category', data.category);
        formData.append('description', data.note);
        formData.append('date', data.date);
        formData.append('transaction_type', 'expense');

        await fetch('/add-transaction', { method: 'POST', body: formData });
        location.reload();
    }

    // 2. LOGIC CHO BI·ªÇU ƒê·ªí (CHART.JS)
    const categoryLabels = JSON.parse('{{ category_labels_json | safe }}');
    const categoryValues = JSON.parse('{{ category_values_json | safe }}');
    const monthlyLabels = ['Th7', 'Th8', 'Th9', 'Th10', 'Th11', 'Th12'];
    const monthlyIncome = [20000, 18000, 22000, 19000, 21000, 25000];
    const monthlyExpenseNegative = [10000, 12000, 15000, 11000, 14000, 16000].map(v => -v);

    // Flow Chart
    new Chart(document.getElementById('monthlyFlowChart'), {
        type: 'bar',
        data: {
            labels: monthlyLabels,
            datasets: [
                { label: 'Thu nh·∫≠p', data: monthlyIncome, backgroundColor: '#10b981', borderRadius: 5 },
                { label: 'Chi ti√™u', data: monthlyExpenseNegative, backgroundColor: '#ef4444', borderRadius: 5 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { ticks: { callback: v => Math.abs(v) + 'K' } } }
        }
    });

    // Pie Chart
    new Chart(document.getElementById('categoryPieChart'), {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{ data: categoryValues, backgroundColor: ['#667eea', '#764ba2', '#4facfe', '#feca57', '#fa709a', '#43e97b'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right' } } }
    });
    function openBalanceModal() {
    document.getElementById('balanceModal').style.display = 'flex';
}

function closeBalanceModal() {
    document.getElementById('balanceModal').style.display = 'none';
}

// ƒê√≥ng modal khi click ra ngo√†i v√πng tr·∫Øng
window.onclick = function(event) {
    const modal = document.getElementById('balanceModal');
    if (event.target == modal) {
        closeBalanceModal();
    }
}
</script>
{% endblock %}