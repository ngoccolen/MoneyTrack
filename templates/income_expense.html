{% extends "base.html" %}

{% block content %}
    <h1>Theo d√µi thu chi</h1>

    <div class="row">
        <div class="col-4">
            <div class="card kpi-finance-card">
                <div class="kpi-label">T·ªïng thu nh·∫≠p</div>
                <div class="kpi-value color-success">{{ vnd(income) }} ƒë</div>
            </div>
        </div>
        <div class="col-4">
            <div class="card kpi-finance-card">
                <div class="kpi-label">T·ªïng chi ti√™u</div>
                <div class="kpi-value color-danger">{{ vnd(expense) }} ƒë</div>
            </div>
        </div>
        <div class="col-4">
            <div class="card kpi-finance-card">
                <div class="kpi-label">S·ªë d∆∞ r√≤ng</div>
                <div class="kpi-value color-primary">{{ vnd(balance) }} ƒë</div>
            </div>
        </div>
    </div>

    <div class="filter-card" style="margin-top: 20px;">
        <form action="{{ url_for('thu_chi') }}" method="GET" class="filter-form">
            <div class="filter-group">
                <label class="filter-label">Th·ªùi gian</label>
                <div class="input-range">
                    <input type="date" name="start_date" class="modern-input" value="{{ request.args.get('start_date', '') }}">
                    <span class="separator">‚Üí</span>
                    <input type="date" name="end_date" class="modern-input" value="{{ request.args.get('end_date', '') }}">
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Danh m·ª•c</label>
                <select name="category_filter" class="modern-input">
                    <option value="all">T·∫•t c·∫£ danh m·ª•c</option>
                    <option value="ƒÇn u·ªëng" {% if request.args.get('category_filter') == 'ƒÇn u·ªëng' %}selected{% endif %}>ƒÇn u·ªëng</option>
                    <option value="L∆∞∆°ng" {% if request.args.get('category_filter') == 'L∆∞∆°ng' %}selected{% endif %}>L∆∞∆°ng</option>
                    <option value="Mua s·∫Øm" {% if request.args.get('category_filter') == 'Mua s·∫Øm' %}selected{% endif %}>Mua s·∫Øm</option>
                    <option value="Nh√† ·ªü" {% if request.args.get('category_filter') == 'Nh√† ·ªü' %}selected{% endif %}>Nh√† ·ªü</option>
                    <option value="Kh√°c" {% if request.args.get('category_filter') == 'Kh√°c' %}selected{% endif %}>Kh√°c</option>
                </select>
            </div>

            <div class="filter-actions" style="align-self: flex-end;">
                <button type="submit" class="btn-search">
                    <i>üîç</i> L·ªçc d·ªØ li·ªáu
                </button>
                <a href="{{ url_for('thu_chi') }}" class="btn-reset">ƒê·∫∑t l·∫°i</a>
            </div>
        </form>
    </div>
    
    <div class="row" style="align-items: center; justify-content: space-between; margin-bottom: 10px; margin-top: 30px;">
        <div class="col-6">
            <h2>L·ªãch s·ª≠ giao d·ªãch</h2>
        </div>
        <div class="col-6" style="text-align: right;">
            <button class="btn btn-primary" id="open-transaction-modal">‚ûï Th√™m giao d·ªãch</button>
        </div>
    </div>

    <div class="card" style="padding: 0;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 15%;">NG√ÄY</th>
                    <th style="width: 30%;">M√î T·∫¢</th>
                    <th style="width: 20%;">DANH M·ª§C</th>
                    <th style="width: 15%;">S·ªê TI·ªÄN</th>
                    <th style="width: 20%; text-align: center;">THAO T√ÅC</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in transactions %}
                <tr>
                    <td>{{ tx.date | format_date }}</td>
                    <td>{{ tx.description }}</td>
                    <td>{{ tx.category }}</td>
                    <td class="{% if tx.amount > 0 %}color-success{% else %}color-danger{% endif %}">
                        {{ vnd(tx.amount) }} ƒë
                    </td>
                    <td style="text-align: center;">
                        <button class="btn btn-secondary" style="padding: 6px 10px; margin-right: 5px;">S·ª≠a</button>
                        <a href="{{ url_for('delete_transaction', id=tx.id) }}" 
                           class="btn btn-danger" 
                           style="padding: 6px 10px; text-decoration: none;"
                           onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?')">X√≥a</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="modal-overlay" id="transaction-modal">
        <div class="modal-content">
            <div class="modal-header">
                Th√™m giao d·ªãch m·ªõi
                <span class="modal-close">&times;</span>
            </div>
            
            <form action="{{ url_for('add_transaction') }}" method="POST">
                <div class="form-group">
                    <label>LO·∫†I GIAO D·ªäCH</label>
                    <div class="toggle-group" id="transaction-type-toggle">
                        <input type="hidden" name="transaction_type" id="transaction-type-input" value="income">
                        <div class="toggle-btn active income" data-type="income">Thu nh·∫≠p</div>
                        <div class="toggle-btn expense" data-type="expense">Chi ti√™u</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="amount">S·ªê TI·ªÄN (VNƒê)</label>
                    <input type="number" id="amount" name="amount" required placeholder="0">
                </div>

                <div class="form-group">
                    <label for="description">M√î T·∫¢</label>
                    <textarea id="description" name="description" placeholder="M√¥ t·∫£ giao d·ªãch" rows="2"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="category">DANH M·ª§C</label>
                    <select id="category" name="category" required>
                        <option value="L∆∞∆°ng">L∆∞∆°ng</option>
                        <option value="Th∆∞·ªüng">Th∆∞·ªüng</option>
                        <option value="B√°n h√†ng">B√°n h√†ng</option>
                        <option value="ƒÇn u·ªëng">ƒÇn u·ªëng</option>
                        <option value="Mua s·∫Øm">Mua s·∫Øm</option>
                        <option value="Di chuy·ªÉn">Di chuy·ªÉn</option>
                        <option value="Nh√† ·ªü">Nh√† ·ªü</option>
                        <option value="Kh√°c">Kh√°c</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="date">NG√ÄY</label>
                    <input type="date" id="date" name="date" required value="{{ datetime.now().strftime('%Y-%m-%d') }}">
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-cancel">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">L∆∞u giao d·ªãch</button>
                </div>
            </form>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('transaction-modal');
        const openBtn = document.getElementById('open-transaction-modal');
        const closeBtn = modal.querySelector('.modal-close');
        const cancelBtn = modal.querySelector('.btn-cancel');
        const typeToggle = document.getElementById('transaction-type-toggle');
        const typeInput = document.getElementById('transaction-type-input');
        
        const closeModal = () => { modal.style.display = 'none'; };
        const openModal = () => { modal.style.display = 'flex'; };

        if(openBtn) openBtn.addEventListener('click', openModal);
        if(closeBtn) closeBtn.addEventListener('click', closeModal);
        if(cancelBtn) cancelBtn.addEventListener('click', closeModal);

        window.addEventListener('click', (event) => {
            if (event.target === modal) closeModal();
        });
        
        typeToggle.querySelectorAll('.toggle-btn').forEach(button => {
            button.addEventListener('click', function() {
                typeToggle.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                typeInput.value = this.dataset.type;
            });
        });
    });
</script>
{% endblock %}